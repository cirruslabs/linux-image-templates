- name: install setup-info-generator, copy setup info template and generate setup info
  hosts: default
  become: yes
  tasks:
    - name: retrieve latest release metadata for setup-info-generator
      ansible.builtin.uri:
        url: "https://api.github.com/repos/cirruslabs/setup-info-generator/releases/latest"
      register: latest_release
    - name: normalize architecture name reported by Ansible to be Golang-like
      set_fact:
        golang_architecture: "{{ mapping.get(ansible_architecture, ansible_architecture) }}"
      vars:
        mapping:
          x86_64: amd64
          aarch64: arm64
    - name: figure out setup-info-generator .deb URL
      set_fact:
        setup_info_generator_deb_url: "{{
          latest_release.json.assets |
          selectattr('name', 'match', '^setup-info-generator_.*_linux_' + golang_architecture + '.deb$') |
          map(attribute='browser_download_url') |
          first
        }}"
    - name: install setup-info-generator
      apt:
        deb: "{{ setup_info_generator_deb_url }}"
    - name: copy setup info template
      copy:
        src: setup-info-template.json
        dest: /tmp/setup-info-template.json
    - name: generate setup info
      shell: "setup-info-generator < /tmp/setup-info-template.json"
      register: setup_info_generator
    - name: write setup info to its final destination
      copy:
        content: "{{ setup_info_generator.stdout }}"
        dest: "/home/admin/actions-runner/.setup_info"
        owner: admin
        group: admin
    - name: cleanup setup info template
      file:
        path: /tmp/setup-info-template.json
        state: absent
